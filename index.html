<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Futuristic Advanced Quiz Helper</title>
<style>
  /* Custom fonts and base styles */
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;600&display=swap');

  * {
    box-sizing: border-box;
  }
  html, body {
    margin: 0; padding: 0;
    width: 100%; height: 100%;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #2f335a, #4e54c8);
    color: #222;
    overflow-x: hidden;
  }
  #app {
    background: #fbfbfb;
    max-width: 1000px;
    margin: 30px auto;
    border-radius: 24px;
    padding: 2rem 3rem 3rem 3rem;
    box-shadow: 0 25px 50px rgba(40, 50, 75, 0.3);
    min-height: 90vh;
    display: flex;
    flex-direction: column;
  }
  header {
    font-weight: 600;
    font-size: 2.5rem;
    color: #222258;
    text-align: center;
    margin-bottom: 2rem;
  }
  nav {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 2.5rem;
  }
  nav button {
    background: #4e54c8;
    color: #fff;
    border: none;
    padding: 14px 28px;
    font-size: 1.1rem;
    border-radius: 12px;
    box-shadow: 0 5px 12px rgba(78, 84, 200, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
  }
  nav button.active, nav button:hover {
    background: #1e1f9b;
  }
  main {
    flex-grow: 1;
    overflow-y: auto;
  }

  /* Login modal global styles */
  #loginModal {
    position: fixed;
    top:0;
    left:0;
    width: 100vw;
    height: 100vh;
    background: rgba(58, 58, 90, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #loginBox {
    background: white;
    padding: 2.5rem 3rem 3rem 3rem;
    border-radius: 24px;
    width: 360px;
    box-shadow: 0 25px 45px rgba(40, 50, 75, 0.3);
    text-align: center;
  }
  #loginBox h2 {
    font-weight: 600;
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    color: #3d3d77;
  }
  #loginInput {
    width: 100%;
    padding: 12px 18px;
    font-size: 1.1rem;
    border-radius: 12px;
    border: 2.2px solid #908fd3;
    outline: none;
    transition: border-color 0.3s ease;
  }
  #loginInput:focus {
    border-color: #4e54c8;
  }
  #loginError {
    color: #b00020;
    margin: 10px 0 0 0;
    font-weight: 600;
    display: none;
  }
  #loginBtn {
    margin-top: 1.6rem;
    background: #4e54c8;
    color: white;
    border: none;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 14px 0;
    width: 100%;
    border-radius: 12px;
    box-shadow: 0 12px 20px rgba(78, 84, 200, 0.45);
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  #loginBtn:hover {
    background: #363c92;
  }

  /* Teacher Dashboard */
  #teacherDashboard {
    display: flex;
    flex-direction: column;
  }
  #addQuestionBtn {
    align-self: flex-end;
    margin-bottom: 1.8rem;
    background-color: #4e54c8;
    color: white;
    border: none;
    font-size: 1.05rem;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 14px;
    box-shadow: 0 9px 22px rgba(78, 84, 200, 0.5);
    cursor: pointer;
    transition: 0.25s all ease;
  }
  #addQuestionBtn:hover {
    background-color: #3a3eb2;
  }

  /* Question card for teacher */
  .question-card {
    background: #f7f9ff;
    border-radius: 20px;
    padding: 2rem 2.5rem;
    margin-bottom: 1.8rem;
    box-shadow: 0 12px 30px rgba(78, 84, 200, 0.1);
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-gap: 20px;
    align-items: center;
    position: relative;
    transition: box-shadow 0.3s ease;
  }
  .question-card:hover {
    box-shadow: 0 20px 40px rgba(78, 84, 200, 0.3);
  }
  .question-text-area {
    grid-column: 1 / -1;
    font-weight: 600;
    font-size: 1.1rem;
    background-color: #e4e8ff;
    border-radius: 14px;
    padding: 14px;
    border: none;
    resize: vertical;
    font-family: 'Poppins', sans-serif;
    min-height: 4.5rem;
    color: #40477a;
    transition: background-color 0.3s ease;
  }
  .question-text-area:focus {
    outline: none;
    background-color: #d0d4ff;
  }

  /* Option input styles */
  .option-input {
    background-color: #ebeefb;
    border-radius: 16px;
    padding: 12px 20px;
    border: none;
    font-size: 1rem;
    font-weight: 500;
    color: #4a4f7a;
    width: 100%;
    transition: background-color 0.3s ease;
  }
  .option-input:focus {
    outline: none;
    background-color: #d0d4ff;
  }

  /* Correct answer radios */
  .correct-answer-label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    cursor: pointer;
  }
  .correct-answer-label input[type='radio'] {
    height: 20px; width: 20px;
    accent-color: #4e54c8;
  }
  .remove-question-btn {
    position: absolute;
    top: 16px;
    right: 18px;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    font-weight: 700;
    color: #bbb;
    cursor: pointer;
    transition: color 0.3s;
  }
  .remove-question-btn:hover {
    color: #4e54c8;
  }

  /* Share link & export data */
  #shareLinkWrapper {
    background-color: #f0f4ff;
    border: 2px solid #4e54c8;
    padding: 16px 20px;
    margin-top: 2rem;
    border-radius: 16px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }
  #shareableLink {
    flex-grow: 1;
    background: white;
    padding: 10px 16px;
    border-radius: 14px;
    border: 1.5px solid #bbc;
    font-family: monospace;
    font-size: 0.95rem;
    color: #555;
    overflow-x: auto;
  }
  #copyLinkBtn {
    background-color: #4e54c8;
    border: none;
    padding: 10px 20px;
    border-radius: 14px;
    color: white;
    cursor: pointer;
    font-weight: 600;
    box-shadow:  0 8px 18px rgba(78, 84, 200, 0.3);
    transition: background-color 0.2s ease;
  }
  #copyLinkBtn:hover {
    background-color: #3a3eb3;
  }
</style>
</head>
<body>
<div id="app">
  <header>Futuristic Quiz Helper</header>
  <nav>
    <button id="teacherBtn" class="active">Teacher Dashboard</button>
    <button id="studentBtn">Student Dashboard</button>
  </nav>
  <main>
    <section id="teacherDashboard">
      <button id="addQuestionBtn">+ Add New Question</button>
      <div id="questionsList"></div>

      <div id="shareLinkWrapper" style="display:none;">
        <input type="text" id="shareableLink" readonly />
        <button id="copyLinkBtn" title="Copy Link to Clipboard">Copy Link</button>
      </div>

      <h2 style="margin-top: 3rem;">Imported Student Submissions</h2>
      <textarea id="studentSubmissionsInput" placeholder="Paste student JSON submissions here" spellcheck="false" style="width: 100%; min-height: 150px; font-family: monospace; font-size: 14px; padding: 12px;"></textarea>
      <button id="checkSubmissionsBtn">Check & Grade Submissions</button>

      <div id="gradingResults" style="margin-top: 2rem;"></div>
    </section>

    <section id="studentDashboard" class="hidden">
      <label for="quizLinkInput" style="font-weight: bold; font-size: 1.1rem;">Paste Quiz Link or JSON here:</label>
      <textarea id="quizLinkInput" placeholder="Paste full quiz JSON or link here..." spellcheck="false" style="width: 100%; height: 140px; font-family: monospace; font-size: 14px; padding: 12px; margin-bottom: 1rem;"></textarea>
      <button id="loadQuizBtn">Load Quiz</button>

      <div id="quizContainer" style="margin-top: 2rem;"></div>

      <button id="submitQuizBtn" style="display:none; margin-top: 1.5rem;">Submit Quiz</button>

      <div id="quizFeedback" style="margin-top: 1.8rem; font-weight: 600;"></div>
    </section>
  </main>
</div>

<!-- Teacher Login Modal -->
<div id="loginModal" style="display:none;">
  <div id="loginBox">
    <h2>Teacher Login</h2>
    <input id="loginInput" type="password" placeholder="Enter teacher password" autofocus autocomplete="new-password" />
    <div id="loginError">Incorrect password</div>
    <button id="loginButton">Login</button>
  </div>
</div>

<script>
  // Global backend URL placeholder
  const API_BASE_URL = "http://REPLACE_WITH_YOUR_BACKEND_URL";

  // Application scope and state
  let teacherAuthenticated = false;
  let questions = [];
  let studentResponses = [];

  // UI elements
  const teacherBtn = document.getElementById('teacherBtn');
  const studentBtn = document.getElementById('studentBtn');

  const teacherDashboard = document.getElementById('teacherDashboard');
  const studentDashboard = document.getElementById('studentDashboard');

  const loginModal = document.getElementById('loginModal');
  const loginInput = document.getElementById('loginInput');
  const loginButton = document.getElementById('loginButton');
  const loginError = document.getElementById('loginError');

  const addQuestionBtn = document.getElementById('addQuestionBtn');
  const questionsList = document.getElementById('questionsList');

  const shareLinkWrapper = document.getElementById('shareLinkWrapper');
  const shareableLink = document.getElementById('shareableLink');
  const copyLinkBtn = document.getElementById('copyLinkBtn');

  const studentSubmissionsInput = document.getElementById('studentSubmissionsInput');
  const checkSubmissionsBtn = document.getElementById('checkSubmissionsBtn');
  const gradingResults = document.getElementById('gradingResults');

  const quizLinkInput = document.getElementById('quizLinkInput');
  const loadQuizBtn = document.getElementById('loadQuizBtn');
  const quizContainer = document.getElementById('quizContainer');
  const submitQuizBtn = document.getElementById('submitQuizBtn');
  const quizFeedback = document.getElementById('quizFeedback');

  // Navigation event handlers
  teacherBtn.addEventListener('click', async () => {
    if (!teacherAuthenticated) {
      // Show login modal
      loginModal.style.display = 'flex';
      loginInput.focus();
    } else {
      switchDashboard('teacher');
    }
  });

  studentBtn.addEventListener('click', () => {
    switchDashboard('student');
  });

  // Login button handler
  loginButton.addEventListener('click', () => {
    const pwd = loginInput.value;
    if (pwd === 'teacherPassword123') {
      teacherAuthenticated = true;
      loginModal.style.display = 'none';
      loginError.style.display = 'none';
      loginInput.value = '';
      switchDashboard('teacher');
      renderQuestionsList();
      shareLinkWrapper.style.display = 'none';
      studentSubmissionsInput.value = '';
      gradingResults.innerHTML = '';
    } else {
      loginError.style.display = 'block';
    }
  });

  // Close login modal on outside click
  loginModal.addEventListener('click', e => {
    if (e.target === loginModal) {
      loginModal.style.display = 'none';
      loginInput.value = '';
      loginError.style.display = 'none';
    }
  });

  // Switch visible dashboard
  function switchDashboard(mode) {
    if (mode === 'teacher') {
      teacherDashboard.style.display = 'block';
      studentDashboard.style.display = 'none';
      teacherBtn.classList.add('active');
      studentBtn.classList.remove('active');
    } else {
      teacherDashboard.style.display = 'none';
      studentDashboard.style.display = 'block';
      teacherBtn.classList.remove('active');
      studentBtn.classList.add('active');
    }
  }

  // Question template creation for teacher
  function createQuestionCard(id, question = '', options = ['', '', '', ''], correct = '') {
    const card = document.createElement('div');
    card.classList.add('question-card');
    card.dataset.id = id;

    card.innerHTML = `
      <textarea class="question-text-area" placeholder="Enter question here..." rows="3"></textarea>
      <input type="text" class="option-input" placeholder="Option A" />
      <input type="text" class="option-input" placeholder="Option B" />
      <input type="text" class="option-input" placeholder="Option C" />
      <input type="text" class="option-input" placeholder="Option D" />
      <div style="display:flex; align-items:center; justify-content: space-between; margin-top: 14px;">
        <label class="correct-answer-label">
          <input type="radio" name="correctAnswer${id}" value="0" />
          Correct Option
        </label>
        <button class="remove-question-btn" title="Remove question">&times;</button>
      </div>
    `;

    // Fill values
    const textarea = card.querySelector('.question-text-area');
    const optionInputs = card.querySelectorAll('.option-input');
    const correctRadios = card.querySelectorAll(`input[name="correctAnswer${id}"]`);
    textarea.value = question;
    optionInputs.forEach((inp, idx) => { inp.value = options[idx]; });
    if (['0','1','2','3'].includes(correct)) {
      correctRadios[correct].checked = true;
    }

    // Remove button
    card.querySelector('.remove-question-btn').addEventListener('click', () => {
      questions.splice(id, 1);
      renderQuestionsList();
      shareLinkWrapper.style.display = 'none';
    });

    return card;
  }

  // Render questions list in teacher dashboard
  function renderQuestionsList() {
    questionsList.innerHTML = '';
    questions.forEach((q, i) => {
      const card = createQuestionCard(i, q.question, q.options, q.correct);
      questionsList.appendChild(card);
    });
  }

  // Add question button logic
  addQuestionBtn.addEventListener('click', () => {
    questions.push({question: '', options: ['', '', '', ''], correct: ''});
    renderQuestionsList();
  });

  // Generate shareable quiz JSON and URL
  const encodeQuizToUrl = (quiz) => {
    const data = encodeURIComponent(JSON.stringify(quiz));
    return `${window.location.origin}${window.location.pathname}#quiz=${data}`;
  };
  const decodeQuizFromUrl = () => {
    if(!window.location.hash.startsWith('#quiz=')) return null;
    try {
      const json = decodeURIComponent(window.location.hash.replace('#quiz=', ''));
      return JSON.parse(json);
    } catch(e) {
      return null;
    }
  };

  // Extract quiz data from teacher inputs
  function extractQuizData() {
    const cards = questionsList.querySelectorAll('.question-card');
    const quizData = [];
    cards.forEach(card => {
      const questionTxt = card.querySelector('.question-text-area').value.trim();
      const optionInputs = card.querySelectorAll('.option-input');
      const options = Array.from(optionInputs).map(input => input.value.trim());
      const correctRadio = card.querySelector('input[type="radio"]:checked');
      if(questionTxt && options.every(op => op) && correctRadio) {
        quizData.push({
          question: questionTxt,
          options: options,
          correct: correctRadio.value,
        });
      }
    });
    return quizData;
  }

  // Button click to generate share link and show in UI
  function generateShareLink() {
    questions = extractQuizData();
    if(questions.length === 0) {
      alert('Please enter at least one valid question with all options and a correct answer.');
      return;
    }
    // Convert correct from '0','1','2','3' string to corresponding char 'A' 'B' 'C' 'D'
    questions = questions.map(q => ({
      question: q.question,
      options: q.options,
      correct: ['A','B','C','D'][q.correct] ?? '',
    }));
    const url = encodeQuizToUrl(questions);
    shareableLink.value = url;
    shareLinkWrapper.style.display = 'flex';
  }

  // Copy shareable quiz link to clipboard
  copyLinkBtn.addEventListener('click', () => {
    shareableLink.select();
    document.execCommand('copy');
    copyLinkBtn.textContent = 'Copied!';
    setTimeout(() => {
      copyLinkBtn.textContent = 'Copy Link';
    }, 2500);
  });

  // Check and score student submissions JSON pasted in textarea
  checkSubmissionsBtn.addEventListener('click', () => {
    const rawData = studentSubmissionsInput.value.trim();
    if (!rawData) {
      alert('Please paste the student submission JSON data before checking.');
      return;
    }

    let submissions;
    try {
      submissions = JSON.parse(rawData);
    } catch (e) {
      alert('Invalid JSON data. Please check and try again.');
      return;
    }

    if (!Array.isArray(submissions)) {
      alert('Student submissions should be an array of submission objects.');
      return;
    }

    // For each submission check answers and compute score
    let resultsHTML = '';

    for (const submission of submissions) {
      if (!submission.answers || !Array.isArray(submission.answers)) {
        resultsHTML += `<p style="color: red;">Invalid submission format, skipping one submission.</p>`;
        continue;
      }

      let score = 0;
      const total = questions.length;
      const answers = submission.answers;

      resultsHTML += `<div style="margin-top: 16px; border-bottom: 2px solid #4e54c8; padding-bottom: 16px;">
        <h3>Submission <small style="font-weight: 400; font-size: 14px; color: #666;">${submission.studentName || 'Student'}</small></h3>`;
      for(let i=0; i<questions.length; i++) {
        const q = questions[i];
        const ans = answers[i] ?? null;
        const isCorrect = ans === q.correct;
        if(isCorrect) score++;

        resultsHTML += `
          <div style="margin-top: 8px;">
            <strong>Q${i+1}:</strong> ${q.question}<br />
            <em>Your answer:</em>
            <span style="color: ${isCorrect ? '#2e7d32' : '#b00020'}; font-weight: 600;">
              ${ans ?? 'No answer'}
            </span><br />
            <em>Correct answer:</em> <span>${q.correct}</span>
          </div>`;
      }
      resultsHTML += `<h4 style="color: #222258; margin-top: 12px;">Score: ${score} / ${total}</h4></div>`;
    }
    gradingResults.innerHTML = resultsHTML;
  });

  // Student side quiz rendering and interaction
  function renderStudentQuiz(quiz = []) {
    if (!quiz.length) {
      quizContainer.innerHTML = '<p>No quiz loaded. Please paste a valid quiz link or data.</p>';
      submitQuizBtn.style.display = 'none';
      quizFeedback.textContent = '';
      return;
    }
    quizContainer.innerHTML = '';

    // Store answers locally
    let studentAnswers = new Array(quiz.length).fill(null);

    // Create question elements with radio buttons
    quiz.forEach((q, i) => {
      const card = document.createElement('article');
      card.classList.add('question-card');
      card.style.gridTemplateColumns = "1fr";
      card.style.marginBottom = "1.8rem";

      const qTitle = document.createElement('h3');
      qTitle.textContent = `Q${i + 1}: ${q.question}`;
      qTitle.style.color = '#4e54c8';
      card.appendChild(qTitle);

      const optionsDiv = document.createElement('div');

      ['A', 'B', 'C', 'D'].forEach((opt, idx) => {
        const label = document.createElement('label');
        label.style.display = 'block';
        label.style.marginBottom = '8px';
        label.style.cursor = 'pointer';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `answer-${i}`;
        radio.value = opt;
        radio.style.marginRight = '10px';

        radio.addEventListener('change', () => {
          studentAnswers[i] = radio.value;
        });

        label.appendChild(radio);
        label.appendChild(document.createTextNode(`${opt}: ${q.options[idx]}`));
        optionsDiv.appendChild(label);
      });

      card.appendChild(optionsDiv);
      quizContainer.appendChild(card);
    });

    submitQuizBtn.style.display = 'block';
quizFeedback.textContent = '';

// Submit button handler
submitQuizBtn.onclick = () => {
  if (studentAnswers.includes(null)) {
    if (!confirm('Some questions are unanswered. Submit anyway?')) return;
  }
  // Create result data object to share with teacher
  const submission = {
    studentName: 'Anonymous',
    timestamp: new Date().toISOString(),
    answers: studentAnswers,
  };
  const submissionJson = JSON.stringify([submission], null, 2);

  quizFeedback.innerHTML = `
    <h3>Quiz Submitted!</h3>
    <p>Copy and send this submission JSON to your teacher:</p>
    <textarea style="width: 100%; height: 160px; font-family: monospace;" readonly>${submissionJson}</textarea>
  `;
  submitQuizBtn.style.display = 'none';
  quizContainer.innerHTML = '';
};

// Drag & drop question reordering (using Drag and Drop API)
function enableDragDrop() {
  let dragSrcEl = null;

  function handleDragStart(e) {
    dragSrcEl = this;
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.outerHTML);
    this.classList.add('dragging');
  }

  function handleDragOver(e) {
    if (e.preventDefault) e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    return false;
  }

  function handleDragEnter(e) {
    this.classList.add('over');
  }

  function handleDragLeave(e) {
    this.classList.remove('over');
  }

  function handleDrop(e) {
    if (e.stopPropagation) e.stopPropagation();

    if (dragSrcEl != this) {
      this.parentNode.removeChild(dragSrcEl);
      const dropHTML = e.dataTransfer.getData('text/html');
      this.insertAdjacentHTML('beforebegin', dropHTML);
      const dropElem = this.previousSibling;
      addDnDHandlers(dropElem);
      updateQuestionsOrder();
    }
    this.classList.remove('over');
    return false;
  }

  function handleDragEnd(e) {
    this.classList.remove('dragging');
    const cards = questionsList.querySelectorAll('.question-card');
    cards.forEach(card => {
      card.classList.remove('over');
    });
  }

  function addDnDHandlers(elem) {
    elem.addEventListener('dragstart', handleDragStart, false);
    elem.addEventListener('dragenter', handleDragEnter, false);
    elem.addEventListener('dragover', handleDragOver, false);
    elem.addEventListener('dragleave', handleDragLeave, false);
    elem.addEventListener('drop', handleDrop, false);
    elem.addEventListener('dragend', handleDragEnd, false);
  }

  const cards = questionsList.querySelectorAll('.question-card');
  cards.forEach(card => {
    card.setAttribute('draggable', 'true');
    addDnDHandlers(card);
  });
}

// After reordering update questions array to match UI order
function updateQuestionsOrder() {
  const cards = questionsList.querySelectorAll('.question-card');
  const newQuestions = [];
  cards.forEach(card => {
    const questionText = card.querySelector('.question-text-area').value.trim();
    const optionInputs = card.querySelectorAll('.option-input');
    const options = Array.from(optionInputs).map(input => input.value.trim());
    const correctRadio = card.querySelector('input[type="radio"]:checked');
    if(questionText && options.length === 4 && correctRadio) {
      newQuestions.push({
        question: questionText,
        options: options,
        correct: ['A','B','C','D'][correctRadio.value] || '',
      });
    }
  });
  questions = newQuestions;
}

// Auto-enable drag-drop any time questions list changes
function initDragDrop() {
  new MutationObserver(() => {
    enableDragDrop();
  }).observe(questionsList, {childList: true});
}

// Initialize drag and drop after initial render
initDragDrop();

// Rich text editor for question text using contentEditable
function enableRichTextEditing() {
  questionsList.querySelectorAll('.question-text-area').forEach(textArea => {
    textArea.contentEditable = true;
  });
}

// Debounced autosave
let autosaveTimer = null;
function initAutoSave() {
  questionsList.addEventListener('input', () => {
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      saveToLocalStorage();
    }, 1200);
  });
}

// Save quiz questions to localStorage
function saveToLocalStorage() {
  const data = extractQuizData();
  localStorage.setItem('savedQuiz', JSON.stringify(data));
}

// Load quiz questions from localStorage
function loadFromLocalStorage() {
  const data = localStorage.getItem('savedQuiz');
  if (data) {
    try {
      const parsed = JSON.parse(data);
      questions = parsed;
      renderQuestionsList();
    } catch(e) {
      console.warn('Failed to load quiz from local storage');
    }
  }
}

// Event: check submissions button with analytics
checkSubmissionsBtn.addEventListener('click', () => {
  const rawData = studentSubmissionsInput.value.trim();
  if (!rawData) {
    alert('Paste submission JSON data to grade.');
    return;
  }
  let submissions;
  try {
    submissions = JSON.parse(rawData);
  } catch(e) {
    alert('Invalid JSON data.');
    return;
  }
  if (!Array.isArray(submissions)) {
    alert('Submissions should be an array.');
    return;
  }
  let aggregateScores = 0;
  let validSubmissions = 0;
  let outputHTML = '';
  submissions.forEach((submission, index) => {
    if (!submission.answers) return;

    validSubmissions++;
    let score = 0;
    const total = questions.length;

    outputHTML += `<h4>Submission #${index + 1} by ${submission.studentName || 'Student'}</h4>`;
    outputHTML += `<ul>`;
    submission.answers.forEach((ans, qIndex) => {
      const correctAns = questions[qIndex]?.correct;
      const isCorrect = ans === correctAns;
      if (isCorrect) score++;
      outputHTML += `<li>Q${qIndex + 1}: ${isCorrect ? '<span style="color:green;">Correct</span>' : '<span style="color:red;">Wrong</span>'} (Your answer: ${ans || 'None'}, Correct: ${correctAns || 'N/A'})</li>`;
    });
    outputHTML += `</ul>`;
    outputHTML += `<b>Score: ${score} / ${total}</b><hr/>`;

    aggregateScores += score;
  });
  if (validSubmissions) {
    outputHTML += `<h3>Average Score: ${(aggregateScores / validSubmissions).toFixed(2)} / ${questions.length}</h3>`;
  }
  gradingResults.innerHTML = outputHTML;
});

// Load saved quiz data on page load
window.onload = () => {
  loadFromLocalStorage();
  renderQuestionsList();
  shareLinkWrapper.style.display = 'none';
};
    // Additional UI polish and user experience improvements

// Floating labels for inputs and textareas
const floatingLabels = () => {
  document.querySelectorAll('input[type="text"], textarea').forEach(input => {
    input.addEventListener('focus', () => {
      input.parentNode.classList.add('focused');
    });
    input.addEventListener('blur', () => {
      if (!input.value) {
        input.parentNode.classList.remove('focused');
      }
    });
  });
};
floatingLabels();

// Smooth scroll to top on dashboard switches
function scrollToTopSmooth() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
teacherBtn.addEventListener('click', scrollToTopSmooth);
studentBtn.addEventListener('click', scrollToTopSmooth);

// Data validation helpers
const isValidQuestion = q => q.question.trim() !== '' && q.options.length === 4 && q.options.every(opt => opt.trim() !== '') && ['A','B','C','D'].includes(q.correct);

// Helper: deep copy quiz before security operations
function deepCopyQuiz(quiz) {
  return quiz.map(q => ({
    question: q.question,
    options: [...q.options],
    correct: q.correct,
  }));
}

// Implement quiz preview feature for teacher dashboard
const previewBtn = document.createElement('button');
previewBtn.textContent = 'Preview Quiz';
previewBtn.style.marginTop = '20px';
previewBtn.style.width = '150px';
previewBtn.style.alignSelf = 'flex-end';
previewBtn.style.backgroundColor = '#3f42b5';
previewBtn.style.boxShadow = '0 5px 15px rgba(63, 66, 181, 0.5)';
previewBtn.style.color = '#fff';
previewBtn.style.cursor = 'pointer';
previewBtn.style.borderRadius = '14px';
previewBtn.style.border = 'none';

teacherDashboard.insertBefore(previewBtn, shareLinkWrapper);

previewBtn.onclick = () => {
  const currentQuiz = extractQuizData();
  if (currentQuiz.length === 0 || !currentQuiz.every(isValidQuestion)) {
    alert('Please complete all questions with valid options and correct answers before preview.');
    return;
  }
  showQuizPreview(currentQuiz);
};

function showQuizPreview(quiz) {
  const modal = document.createElement('div');
  modal.style.position = 'fixed';
  modal.style.top = 0;
  modal.style.left = 0;
  modal.style.width = '100vw';
  modal.style.height = '100vh';
  modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
  modal.style.display = 'flex';
  modal.style.justifyContent = 'center';
  modal.style.alignItems = 'center';
  modal.style.zIndex = 10000;

  const container = document.createElement('div');
  container.style.width = '90vw';
  container.style.maxHeight = '80vh';
  container.style.overflowY = 'auto';
  container.style.background = '#fff';
  container.style.borderRadius = '20px';
  container.style.padding = '2rem';
  container.style.boxShadow = '0 20px 30px rgba(78, 84, 200, 0.4)';
  container.style.position = 'relative';

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close Preview';
  closeBtn.style.position = 'absolute';
  closeBtn.style.top = '10px';
  closeBtn.style.right = '10px';
  closeBtn.style.background = '#3f42b5';
  closeBtn.style.color = 'white';
  closeBtn.style.border = 'none';
  closeBtn.style.padding = '10px 20px';
  closeBtn.style.cursor = 'pointer';
  closeBtn.style.borderRadius = '12px';

  closeBtn.onclick = () => {
    document.body.removeChild(modal);
  };

  container.appendChild(closeBtn);
  const title = document.createElement('h2');
  title.textContent = 'Quiz Preview';
  title.style.color = '#4e54c8';
  title.style.marginBottom = '20px';
  container.appendChild(title);

  quiz.forEach((q, idx) => {
    const div = document.createElement('div');
    div.style.padding = '1rem 0';
    div.style.borderBottom = '1px solid #ddd';

    const qTitle = document.createElement('h3');
    qTitle.textContent = `Q${idx + 1}: ${q.question}`;
    qTitle.style.marginBottom = '10px';
    div.appendChild(qTitle);

    const ul = document.createElement('ul');
    ul.style.listStyle = 'none';
    ul.style.padding = 0;

    ['A', 'B', 'C', 'D'].forEach((opt, i) => {
      const li = document.createElement('li');
      li.textContent = `${opt}: ${q.options[i]}`;
      li.style.color = opt === q.correct ? '#2e7d32' : '#444';
      li.style.fontWeight = opt === q.correct ? 'bold' : 'normal';
      li.style.marginBottom = '6px';
      ul.appendChild(li);
    });
    div.appendChild(ul);
    container.appendChild(div);
  });

  modal.appendChild(container);
  document.body.appendChild(modal);
}

// Accessibility improvements: Keyboard navigation hints
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    const modals = document.querySelectorAll('div[style*="position: fixed"]');
    modals.forEach(modal => {
      if (modal.parentNode) {
        modal.parentNode.removeChild(modal);
      }
    });
  }
});

// Better user feedback for clipboard copy success/fail
copyLinkBtn.addEventListener('click', () => {
  navigator.clipboard.writeText(shareableLink.value).then(() => {
    copyLinkBtn.textContent = 'Copied!';
    setTimeout(() => {
      copyLinkBtn.textContent = 'Copy Link';
    }, 2000);
  }, () => {
    alert('Failed to copy link automatically. Please copy manually.');
  });
});

// Initialize with loading saved quiz data or a sample
window.addEventListener('load', () => {
  const savedQuiz = localStorage.getItem('savedQuiz');
  if (savedQuiz) {
    try {
      questions = JSON.parse(savedQuiz);
      renderQuestionsList();
    } catch {
      questions = [];
    }
  } else {
    questions = [
      {
        question: 'Welcome to Futuristic Quiz Helper! Start by editing this question.',
        options: ['Option A', 'Option B', 'Option C', 'Option D'],
        correct: 'A',
      },
    ];
    renderQuestionsList();
  }
});
    // Student dashboard enhancements: show available quizzes dynamically (simulated)
const studentQuizzes = []; // Will hold quizzes loaded by student

// Simulate "dashboard" quizzes for student with localStorage or memory
function addQuizToStudentDashboard(quizJSON) {
  try {
    const quiz = JSON.parse(quizJSON);
    studentQuizzes.push(quiz);
    renderStudentAvailableQuizzes();
  } catch (e) {
    console.error('Invalid quiz JSON for student dashboard:', e);
  }
}

function renderStudentAvailableQuizzes() {
  const container = document.getElementById('quizContainer');
  container.innerHTML = '';

  if (studentQuizzes.length === 0) {
    container.innerHTML = '<p>No quizzes available. Paste a quiz JSON or link to start one.</p>';
    submitQuizBtn.style.display = 'none';
    return;
  }

  studentQuizzes.forEach((quiz, idx) => {
    const quizCard = document.createElement('article');
    quizCard.classList.add('question-card');
    quizCard.style.cursor = 'pointer';

    const qCount = quiz.length;

    quizCard.innerHTML = `
      <h3>Quiz #${idx + 1} - ${qCount} Questions</h3>
      <button style="margin-top:10px; background:#4e54c8; color:#fff; border:none; padding:10px 20px; border-radius:14px; cursor:pointer;">Start</button>
    `;

    quizCard.querySelector('button').addEventListener('click', () => {
      renderStudentQuiz(quiz);
    });

    container.appendChild(quizCard);
  });

  submitQuizBtn.style.display = 'block';
  quizFeedback.textContent = '';
}

// Extend load quiz button to add quiz to dashboard
loadQuizBtn.addEventListener('click', () => {
  const rawText = quizLinkInput.value.trim();
  if (!rawText) {
    alert("Please paste quiz JSON or link");
    return;
  }
  let parsedQuiz = null;

  if (rawText.startsWith('http')) {
    // Try to extract data from URL hash or query param
    try {
      const url = new URL(rawText);
      let quizDataEncoded = url.hash.startsWith('#quiz=') ? url.hash.replace('#quiz=', '') : null;
      if (!quizDataEncoded) quizDataEncoded = url.searchParams.get('quiz');
      if (quizDataEncoded) {
        parsedQuiz = JSON.parse(decodeURIComponent(quizDataEncoded));
      }
    } catch (e) {
      alert("Failed to parse quiz data from URL");
      return;
    }
  } else {
    try {
      parsedQuiz = JSON.parse(rawText);
    } catch (e) {
      alert("Invalid quiz JSON data");
      return;
    }
  }

  if (!Array.isArray(parsedQuiz) || parsedQuiz.length === 0) {
    alert("Quiz data is empty or invalid");
    return;
  }

  addQuizToStudentDashboard(JSON.stringify(parsedQuiz));
  quizLinkInput.value = '';
});

// Responsive & keyboard accessibility improvements
document.addEventListener('keyup', e => {
  if (e.key === 'Enter') {
    if (document.activeElement === loginInput) {
      loginButton.click();
    }
    if (document.activeElement === quizLinkInput) {
      loadQuizBtn.click();
    }
  }
});

// Dark mode toggle (bonus feature)
const darkModeToggle = document.createElement('button');
darkModeToggle.textContent = 'Toggle Dark Mode';
darkModeToggle.style.position = 'fixed';
darkModeToggle.style.bottom = '30px';
darkModeToggle.style.right = '30px';
darkModeToggle.style.padding = '12px 20px';
darkModeToggle.style.borderRadius = '18px';
darkModeToggle.style.border = 'none';
darkModeToggle.style.backgroundColor = '#4e54c8';
darkModeToggle.style.color = '#fff';
darkModeToggle.style.fontWeight = '600';
darkModeToggle.style.boxShadow = '0 10px 20px rgba(78, 84, 200, 0.4)';
darkModeToggle.style.cursor = 'pointer';
darkModeToggle.style.zIndex = '9999';

document.body.appendChild(darkModeToggle);

darkModeToggle.onclick = () => {
  document.body.classList.toggle('dark-mode');
};

const darkModeCSS = document.createElement('style');
darkModeCSS.textContent = `
  body.dark-mode {
    background: #121212 !important;
    color: #bbbbbb !important;
  }
  body.dark-mode #app {
    background: #222 !important;
    color: #eee !important;
  }
  body.dark-mode nav button {
    background: #5555dd !important;
  }
  body.dark-mode nav button.active, body.dark-mode nav button:hover {
    background: #222299 !important;
  }
  body.dark-mode .question-card {
    background: #333 !important;
    color: #eee !important;
  }
  body.dark-mode textarea, body.dark-mode input, body.dark-mode select {
    background: #222 !important;
    color: #eee !important;
    border-color: #555 !important;
  }
`;
document.head.appendChild(darkModeCSS);
    // (continued from previous)

// Additional utilities and helpers

// Simple escape HTML utility for safety
function escapeHtml(text) {
  const p = document.createElement('p');
  p.appendChild(document.createTextNode(text));
  return p.innerHTML;
}

// Validate quiz format - question text length, unique options, non-empty, etc.
function validateQuiz(quiz) {
  if (!Array.isArray(quiz)) return false;
  return quiz.every(q => {
    if (typeof q.question !== 'string' || q.question.trim() === '') return false;
    if (!Array.isArray(q.options) || q.options.length !== 4) return false;
    if (!['A', 'B', 'C', 'D'].includes(q.correct)) return false;
    // Options unique and non empty
    const opts = new Set(q.options.map(o => o.trim()));
    if (opts.size < 4) return false;
    if (q.options.some(o => o.trim() === '')) return false;
    return true;
  });
}

// On teacher dashboards, bind inputs with debounced saves
function bindInputsDebouncedSave() {
  let debounceTimer;
  questionsList.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      questions = extractQuizData();
      saveToLocalStorage();
      shareLinkWrapper.style.display = 'none';
    }, 800);
  });
}
bindInputsDebouncedSave();

// Export quiz as compact compressed JSON string (optional)
// For now skip compression for simplicity

// Prevent accidental page refresh or close without saving
window.addEventListener('beforeunload', (e) => {
  if (questions.length > 0) {
    e.preventDefault();
    e.returnValue = '';
  }
});

// Responsive improvements
window.addEventListener('resize', handleResponsiveAdjustments);
function handleResponsiveAdjustments() {
  const w = window.innerWidth;
  if (w <= 600) {
    questionsList.style.gridTemplateColumns = '1fr';
  } else {
    questionsList.style.gridTemplateColumns = '1fr 1fr';
  }
}
handleResponsiveAdjustments();

// Info tooltip helper
function createTooltip(text) {
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  tooltip.textContent = text;
  return tooltip;
}

// Attach tooltips to elements marked with data-tooltip
document.querySelectorAll('[data-tooltip]').forEach(el => {
  el.addEventListener('mouseenter', () => {
    const tooltip = createTooltip(el.dataset.tooltip);
    document.body.appendChild(tooltip);
    const rect = el.getBoundingClientRect();
    tooltip.style.top = `${rect.top - 30}px`;
    tooltip.style.left = `${rect.left}px`;
    el._tooltip = tooltip;
  });
  el.addEventListener('mouseleave', () => {
    const tooltip = el._tooltip;
    if (tooltip) tooltip.remove();
  });
});

// Advanced animation on buttons hover using GSAP (optional, add library first)
// For demo, simulate smooth color gradual change
const animatedButtons = document.querySelectorAll('button');
animatedButtons.forEach(btn => {
  btn.addEventListener('mouseenter', () => {
    btn.style.transition = 'background-color 0.35s ease';
    btn.style.backgroundColor = '#3a3eb2';
  });
  btn.addEventListener('mouseleave', () => {
    btn.style.transition = 'background-color 0.35s ease';
    btn.style.backgroundColor = '';
  });
});

// Initialize everything after short delay for DOM readiness
setTimeout(() => {
  renderQuestionsList();
  shareLinkWrapper.style.display = 'none';
}, 200);
    // Feature: Export quiz as printable PDF (basic implementation)
function exportQuizAsPDF() {
  const quizData = extractQuizData();
  if (quizData.length === 0) {
    alert('No questions to export.');
    return;
  }
  let printContent = '<h1>Quiz Export</h1><ol>';
  quizData.forEach(q => {
    printContent += `<li><b>${escapeHtml(q.question)}</b><ul>`;
    ['A', 'B', 'C', 'D'].forEach((opt, i) => {
      printContent += `<li>${opt}: ${escapeHtml(q.options[i])} ${q.correct === opt ? '<b>(Correct)</b>' : ''}</li>`;
    });
    printContent += '</ul></li>';
  });
  printContent += '</ol>';

  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Quiz Export</title>');
  printWindow.document.write('<style>body{font-family: Poppins,sans-serif; margin: 2rem;} h1 {color:#4e54c8;} ul {margin: 0 0 1.5rem 1.2rem;}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(printContent);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}

// Add export to PDF button
const exportPdfBtn = document.createElement('button');
exportPdfBtn.textContent = 'Export Quiz as PDF';
exportPdfBtn.style.marginTop = '16px';
exportPdfBtn.style.alignSelf = 'flex-end';
exportPdfBtn.style.backgroundColor = '#4e54c8';
exportPdfBtn.style.boxShadow = '0 5px 15px rgba(78, 84, 200, 0.5)';
exportPdfBtn.style.color = '#fff';
exportPdfBtn.style.cursor = 'pointer';
exportPdfBtn.style.borderRadius = '14px';
exportPdfBtn.style.border = 'none';

teacherDashboard.insertBefore(exportPdfBtn, shareLinkWrapper);

exportPdfBtn.onclick = () => {
  exportQuizAsPDF();
};

// Feature: Clear all quiz data from localStorage
const clearStorageBtn = document.createElement('button');
clearStorageBtn.textContent = 'Clear Saved Quiz';
clearStorageBtn.style.marginTop = '10px';
clearStorageBtn.style.alignSelf = 'flex-end';
clearStorageBtn.style.backgroundColor = '#cc0033';
clearStorageBtn.style.boxShadow = '0 5px 15px rgba(204, 0, 51, 0.6)';
clearStorageBtn.style.color = '#fff';
clearStorageBtn.style.cursor = 'pointer';
clearStorageBtn.style.borderRadius = '14px';
clearStorageBtn.style.border = 'none';

teacherDashboard.insertBefore(clearStorageBtn, shareLinkWrapper);

clearStorageBtn.onclick = () => {
  if (confirm('Are you sure you want to clear all saved quiz data?')) {
    questions = [];
    questionsList.innerHTML = '';
    localStorage.removeItem('savedQuiz');
    shareLinkWrapper.style.display = 'none';
    gradingResults.innerHTML = '';
  }
};

// Feature: Support question duplication for teacher
function duplicateQuestion(idx) {
  if (questions.length <= idx) return;
  const source = questions[idx];
  const copy = {
    question: source.question,
    options: [...source.options],
    correct: source.correct,
  };
  questions.splice(idx + 1, 0, copy);
  renderQuestionsList();
}

// Add duplicate buttons to question cards dynamically
function addDuplicateButtons() {
  const cards = questionsList.querySelectorAll('.question-card');
  cards.forEach((card, i) => {
    let dupBtn = card.querySelector('.duplicate-question-btn');
    if (!dupBtn) {
      dupBtn = document.createElement('button');
      dupBtn.className = 'duplicate-question-btn';
      dupBtn.textContent = 'Duplicate';
      dupBtn.style.position = 'absolute';
      dupBtn.style.bottom = '12px';
      dupBtn.style.right = '18px';
      dupBtn.style.fontWeight = '600';
      dupBtn.style.border = 'none';
      dupBtn.style.borderRadius = '10px';
      dupBtn.style.padding = '6px 14px';
      dupBtn.style.cursor = 'pointer';
      dupBtn.style.backgroundColor = '#5e78ff';
      dupBtn.style.color = 'white';
      dupBtn.style.boxShadow = '0 8px 18px rgba(94, 120, 255, 0.8)';
      card.appendChild(dupBtn);

      dupBtn.onclick = () => {
        duplicateQuestion(i);
      };
    }
  });
}

function renderQuestionsList() {
  questionsList.innerHTML = '';
  questions.forEach((q, i) => {
    const card = createQuestionCard(i, q.question, q.options, ['A', 'B', 'C', 'D'].indexOf(q.correct).toString());
    questionsList.appendChild(card);
  });
  addDuplicateButtons();
  enableDragDrop();
  bindInputsDebouncedSave();
  shareLinkWrapper.style.display = 'none';
}

// Call renderQuestionsList() also after question duplication and other changes
    // Finalizing event bindings and utility functions

// Utility: Debounce function
function debounce(func, wait, immediate) {
  let timeout;
  return function() {
    const context = this, args = arguments;
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      timeout = null;
      if (!immediate) func.apply(context, args);
    }, wait);
    if (immediate && !timeout) func.apply(context, args);
  };
}

// Save to local storage with debounce to reduce frequent writes
const debouncedSave = debounce(() => {
  saveToLocalStorage();
}, 1000);

questionsList.addEventListener('input', () => {
  debouncedSave();
});

// Override the default alert to show custom toast notifications
function toast(message, duration = 2500) {
  let toastDiv = document.getElementById('customToast');
  if (!toastDiv) {
    toastDiv = document.createElement('div');
    toastDiv.id = 'customToast';
    toastDiv.style.position = 'fixed';
    toastDiv.style.bottom = '40px';
    toastDiv.style.right = '40px';
    toastDiv.style.padding = '16px 28px';
    toastDiv.style.backgroundColor = '#4e54c8';
    toastDiv.style.color = 'white';
    toastDiv.style.fontWeight = '600';
    toastDiv.style.borderRadius = '16px';
    toastDiv.style.boxShadow = '0 4px 15px rgba(78, 84, 200, 0.8)';
    toastDiv.style.zIndex = 100000;
    toastDiv.style.opacity = 0;
    toastDiv.style.transition = 'opacity 0.5s ease';
    document.body.appendChild(toastDiv);
  }
  toastDiv.textContent = message;
  toastDiv.style.opacity = 1;
  setTimeout(() => {
    toastDiv.style.opacity = 0;
  }, duration);
}

// Replace default alert with toast for user feedback
window.alert = (message) => {
  toast(message);
};

// Prevent form submission by Enter key inside textareas and inputs to avoid accidental submits
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && e.target.tagName === 'TEXTAREA') {
    e.preventDefault();
  }
});

// Sanitize paste in textareas to plain text only (avoid rich content)
document.querySelectorAll('textarea').forEach(ta => {
  ta.addEventListener('paste', e => {
    e.preventDefault();
    let plainText = (e.clipboardData || window.clipboardData).getData('text/plain');
    document.execCommand('insertText', false, plainText);
  });
});

// Accessibility: Focus outlines only on keyboard navigation
document.body.addEventListener('mousedown', () => {
  document.body.classList.add('using-mouse');
});
document.body.addEventListener('keydown', e => {
  if (e.key === 'Tab') {
    document.body.classList.remove('using-mouse');
  }
});

// All done, init render
window.onload = () => {
  loadFromLocalStorage();
  renderQuestionsList();
  shareLinkWrapper.style.display = 'none';
  switchDashboard('student');
  darkModeToggle.textContent = 'Toggle Dark Mode';
  // If previously dark mode setting saved
  if (localStorage.getItem('darkMode') === 'true') {
    document.body.classList.add('dark-mode');
  }
};
</script>
</body>
</html>
